import React, { useEffect, useMemo, useState } from 'react';
import {
  fetchCurrentQuestion,
  startTimer,
  stopTimer,
  revealAnswers,
  startNextQuestion,
  setLanguage,
  fetchQuestions,
  startQuestion
} from '../api';
import { AnyQuestion } from '@shared/quizTypes';
import { categoryColors } from '../categoryColors';
import { categoryIcons } from '../categoryAssets';
import { useQuizSocket } from '../hooks/useQuizSocket';

type AnswersState = {
  answers: Record<string, { answer: unknown }>;
  teams: Record<string, { name: string }>;
};

const card: React.CSSProperties = {
  background: 'linear-gradient(145deg, rgba(15,18,28,0.95), rgba(16,18,28,0.82))',
  border: '1px solid rgba(255,255,255,0.08)',
  borderRadius: 16,
  padding: 14,
  boxShadow: '0 12px 28px rgba(0,0,0,0.35)'
};

const inputStyle: React.CSSProperties = {
  width: '100%',
  padding: '10px 12px',
  borderRadius: 12,
  border: '1px solid rgba(255,255,255,0.1)',
  background: '#0f141d',
  color: '#f8fafc'
};

const ModeratorPage: React.FC = () => {
  const [roomCode, setRoomCode] = useState('MAIN');
  const [language, setLang] = useState<'de' | 'en'>('de');
  const [question, setQuestion] = useState<AnyQuestion | null>(null);
  const [meta, setMeta] = useState<{ globalIndex?: number; globalTotal?: number; categoryKey?: string } | null>(null);
  const [answers, setAnswers] = useState<AnswersState | null>(null);
  const [loading, setLoading] = useState(false);
  const [toast, setToast] = useState<string | null>(null);
  const [timerSeconds, setTimerSeconds] = useState(30);
  const [questionsList, setQuestionsList] = useState<AnyQuestion[]>([]);
  const [teleprompter, setTeleprompter] = useState(false);
  const [categoryIntroId, setCategoryIntroId] = useState<string>('');
  const socketEvents = useQuizSocket(roomCode);

  useEffect(() => {
    const saved = localStorage.getItem('moderatorRoom');
    if (saved) setRoomCode(saved);
  }, []);

  useEffect(() => {
    if (!roomCode) return;
    localStorage.setItem('moderatorRoom', roomCode);
    setLoading(true);
    const load = async () => {
      try {
        const res = await fetchCurrentQuestion(roomCode);
        setQuestion(res.question);
        setMeta(res.meta ?? null);
        const qList = await fetchQuestions();
        setQuestionsList(qList.questions);
      } catch (err) {
        // noop
      } finally {
        setLoading(false);
      }
    };
    load();
  }, [roomCode]);

  // Socket updates (push)
  useEffect(() => {
    if (socketEvents.currentQuestion !== undefined) {
      setQuestion(socketEvents.currentQuestion ?? null);
    }
    if (socketEvents.answers || socketEvents.teams) {
      setAnswers((prev) => ({
        answers: socketEvents.answers ?? prev?.answers ?? {},
        teams: socketEvents.teams ?? prev?.teams ?? {}
      }));
    }
  }, [socketEvents]);

  const numericStats = useMemo(() => {
    if (!answers) return null;
    const values = Object.values(answers.answers)
      .map((a) => (typeof a.answer === 'number' ? a.answer : Number(a.answer)))
      .filter((v) => !Number.isNaN(v));
    if (!values.length) return null;
    const sorted = [...values].sort((a, b) => a - b);
    const min = sorted[0];
    const max = sorted[sorted.length - 1];
    const median = sorted[Math.floor(sorted.length / 2)];
    const avg = sorted.reduce((s, v) => s + v, 0) / sorted.length;
    return { min, max, median, avg: Math.round(avg * 100) / 100, count: values.length };
  }, [answers]);

  const topTexts = useMemo(() => {
    if (!answers) return [];
    const freq: Record<string, number> = {};
    Object.values(answers.answers).forEach((a) => {
      if (typeof a.answer === 'string') {
        const key = a.answer.trim() || '(leer)';
        freq[key] = (freq[key] || 0) + 1;
      }
    });
    return Object.entries(freq)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3);
  }, [answers]);

  const funFact = (question as any)?.meta?.funFact as string | undefined;
  const catKey = (question as any)?.category as keyof typeof categoryColors;
  const catColor = catKey ? categoryColors[catKey] ?? '#e1b75d' : '#e1b75d';

  const doAction = async (fn: () => Promise<unknown>, msg: string) => {
    if (!roomCode) return;
    await fn();
    setToast(msg);
    setTimeout(() => setToast(null), 2000);
  };

  const unansweredList = useMemo(() => {
    if (!answers) return [];
    const answeredIds = new Set(Object.keys(answers.answers));
    return Object.entries(answers.teams)
      .map(([id, team]) => ({ id, name: team.name, answered: answeredIds.has(id) }))
      .sort((a, b) => Number(a.answered) - Number(b.answered));
  }, [answers]);

  return (
    <main
      style={{
        minHeight: '100vh',
        background: '#0c111a',
        color: '#f8fafc',
        padding: 14,
        fontFamily: 'Inter, system-ui',
        display: 'flex',
        flexDirection: 'column',
        gap: 12,
        maxWidth: 900,
        margin: '0 auto'
      }}
    >
      <div
        style={{
          position: 'sticky',
          top: 0,
          zIndex: 10,
          paddingBottom: 6,
          background: 'linear-gradient(180deg, rgba(12,17,26,0.96) 0%, rgba(12,17,26,0.82) 100%)',
          backdropFilter: 'blur(8px)'
        }}
      >
        <header
          style={{
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))',
            gap: 8
          }}
        >
          <div style={card}>
            <div style={{ fontWeight: 800, marginBottom: 6 }}>Raum-Code</div>
            <input value={roomCode} onChange={(e) => setRoomCode(e.target.value)} style={inputStyle} />
            <div style={{ marginTop: 8, display: 'flex', gap: 8 }}>
              <select
                value={language}
                onChange={(e) => setLang(e.target.value as 'de' | 'en')}
                style={{ ...inputStyle, background: '#101520', color: '#f8fafc' }}
              >
                <option value="de">Deutsch</option>
                <option value="en">English</option>
              </select>
              <button
                style={{ ...inputStyle, background: '#6dd5fa', color: '#0d0f14', cursor: 'pointer' }}
                onClick={() => doAction(() => setLanguage(roomCode, language), 'Sprache gesetzt')}
              >
                Sprache setzen
              </button>
            </div>
          </div>
          <div style={card}>
            <div style={{ fontWeight: 800, marginBottom: 6 }}>Timer</div>
            <div style={{ display: 'flex', gap: 8 }}>
              <input
                type="number"
                value={timerSeconds}
                min={5}
                max={180}
                onChange={(e) => setTimerSeconds(Number(e.target.value))}
                style={inputStyle}
              />
              <button
                style={{ ...inputStyle, background: '#4ade80', color: '#0d0f14', cursor: 'pointer' }}
                onClick={() => doAction(() => startTimer(roomCode, timerSeconds), 'Timer gestartet')}
              >
                Start
              </button>
              <button
                style={{ ...inputStyle, background: '#f87171', color: '#0d0f14', cursor: 'pointer' }}
                onClick={() => doAction(() => stopTimer(roomCode), 'Timer gestoppt')}
              >
                Stop
              </button>
            </div>
          </div>
        </header>

        <section
          style={{
            marginTop: 10,
            ...card,
            display: 'grid',
            gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
            gap: 10
          }}
        >
          <button
            style={{ ...inputStyle, background: '#4ade80', color: '#0d0f14', cursor: 'pointer', height: 56, fontSize: 15 }}
            onClick={() => doAction(() => startNextQuestion(roomCode), 'NÃ¤chste Frage')}
          >
            NÃ¤chste Frage
          </button>
          <button
            style={{ ...inputStyle, background: '#fbbf24', color: '#0d0f14', cursor: 'pointer', height: 56, fontSize: 15 }}
            onClick={() => doAction(() => revealAnswers(roomCode), 'Antworten aufgedeckt')}
          >
            Antworten aufdecken
          </button>
          <button
            style={{ ...inputStyle, background: '#6dd5fa', color: '#0d0f14', cursor: 'pointer', height: 56, fontSize: 15 }}
            onClick={() =>
              doAction(
                () =>
                  fetch(`/api/rooms/${roomCode}/show-intro`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                  }),
                'Intro gestartet'
              )
            }
          >
            Intro zeigen
          </button>
          <button
            style={{ ...inputStyle, background: '#1f2937', color: '#f8fafc', cursor: 'pointer', height: 56, fontSize: 15 }}
            onClick={() => setTeleprompter((v) => !v)}
          >
            Teleprompter: {teleprompter ? 'An' : 'Aus'}
          </button>
        </section>
      </div>

      <section
        style={{
          ...card,
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))',
          gap: 10
        }}
      >
        <button
          style={{ ...inputStyle, background: '#4ade80', color: '#0d0f14', cursor: 'pointer', height: 56 }}
          onClick={() => doAction(() => startNextQuestion(roomCode), 'NÃ¤chste Frage')}
        >
          NÃ¤chste Frage
        </button>
        <button
          style={{ ...inputStyle, background: '#fbbf24', color: '#0d0f14', cursor: 'pointer', height: 56 }}
          onClick={() => doAction(() => revealAnswers(roomCode), 'Antworten aufgedeckt')}
        >
          Antworten aufdecken
        </button>
        <button
          style={{ ...inputStyle, background: '#6dd5fa', color: '#0d0f14', cursor: 'pointer', height: 56 }}
          onClick={() =>
            doAction(
              () =>
                fetch(`/api/rooms/${roomCode}/show-intro`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' }
                }),
              'Intro gestartet'
            )
          }
        >
          Intro zeigen
        </button>
        <button
          style={{ ...inputStyle, background: '#1f2937', color: '#f8fafc', cursor: 'pointer', height: 56 }}
          onClick={() => setTeleprompter((v) => !v)}
        >
          Teleprompter: {teleprompter ? 'An' : 'Aus'}
        </button>
      </section>

      <section style={card}>
        <div style={{ display: 'flex', alignItems: 'center', gap: 10 }}>
          {question && (
            <div
              style={{
                width: 42,
                height: 42,
                borderRadius: '50%',
                background: '#0f141d',
                border: `2px solid ${catColor}`,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                overflow: 'hidden'
              }}
            >
              <img src={categoryIcons[catKey]} alt="cat" style={{ width: 28, height: 28 }} />
            </div>
          )}
          <div>
            <div style={{ fontSize: 12, letterSpacing: '0.08em', textTransform: 'uppercase', color: '#cbd5e1' }}>
              Aktuelle Frage
            </div>
            <div
              style={{
                fontWeight: 800,
                fontSize: teleprompter ? 26 : 18,
                lineHeight: teleprompter ? 1.2 : 1.3,
                marginTop: teleprompter ? 6 : 0
              }}
            >
              {question?.question ?? 'Keine Frage aktiv'}
            </div>
            {meta?.globalIndex != null && (
              <div style={{ fontSize: 12, color: '#94a3b8' }}>
                {meta.globalIndex}/{meta.globalTotal} Â· {meta.categoryKey}
              </div>
            )}
          </div>
        </div>
        {funFact && (
          <div
            style={{
              marginTop: 10,
              padding: 10,
              borderRadius: 12,
              background: 'rgba(255,255,255,0.04)',
              border: '1px solid rgba(255,255,255,0.08)'
            }}
          >
            <div style={{ fontWeight: 700, marginBottom: 4 }}>Fun Fact</div>
            <div style={{ color: '#e2e8f0' }}>{funFact}</div>
          </div>
        )}
        <div style={{ marginTop: 12, display: 'flex', gap: 8, flexWrap: 'wrap' }}>
          <button
            style={{ ...inputStyle, background: '#6dd5fa', color: '#0d0f14', cursor: 'pointer', flex: '1 1 140px' }}
            onClick={() => {
              if (window.confirm('NÃ¤chste Frage starten?')) doAction(() => startNextQuestion(roomCode), 'NÃ¤chste Frage');
            }}
          >
            NÃ¤chste Frage
          </button>
          <button
            style={{ ...inputStyle, background: '#fde68a', color: '#0d0f14', cursor: 'pointer', flex: '1 1 140px' }}
            onClick={() => {
              if (window.confirm('Antworten wirklich aufdecken?')) doAction(() => revealAnswers(roomCode), 'Aufgedeckt');
            }}
          >
            Antworten aufdecken
          </button>
          <button
            style={{ ...inputStyle, background: '#1f2937', color: '#f8fafc', cursor: 'pointer', flex: '1 1 140px' }}
            onClick={() => setTeleprompter((v) => !v)}
          >
            Teleprompter: {teleprompter ? 'An' : 'Aus'}
          </button>
        </div>
        <div style={{ marginTop: 10, display: 'grid', gridTemplateColumns: '1fr', gap: 8 }}>
          <label style={{ fontSize: 12, color: '#cbd5e1' }}>Kategorie-Intro / Slot starten</label>
          <select
            style={{ ...inputStyle, background: '#101520', color: '#f8fafc' }}
            value={categoryIntroId}
            onChange={(e) => setCategoryIntroId(e.target.value)}
          >
            <option value="">Kategorie wÃ¤hlen â€¦</option>
            {questionsList
              .map((q) => q.category)
              .filter((v, i, arr) => arr.indexOf(v) === i)
              .map((cat) => (
                <option key={cat} value={cat}>
                  {cat}
                </option>
              ))}
          </select>
          <button
            style={{ ...inputStyle, background: '#fbbf24', color: '#0d0f14', cursor: 'pointer' }}
            onClick={() => {
              if (!categoryIntroId) return;
              if (!window.confirm(`Kategorie-Intro fÃ¼r ${categoryIntroId} auslÃ¶sen?`)) return;
              const candidate = questionsList.find((q) => q.category === categoryIntroId);
              if (candidate) {
                doAction(() => fetch(`/api/rooms/${roomCode}/slot-intro`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ questionId: candidate.id })
                }), `Kategorie-Intro: ${categoryIntroId}`);
              } else {
                setToast('Keine Frage fÃ¼r diese Kategorie gefunden');
                setTimeout(() => setToast(null), 2000);
              }
            }}
          >
            Intro abspielen
          </button>
          <button
            style={{ ...inputStyle, background: '#6dd5fa', color: '#0d0f14', cursor: 'pointer' }}
            onClick={() => {
              if (!window.confirm('Intro/Regeln jetzt auf dem Beamer zeigen?')) return;
              doAction(
                () =>
                  fetch(`/api/rooms/${roomCode}/show-intro`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                  }),
                'Intro gestartet'
              );
            }}
          >
            Intro auf Beamer zeigen
          </button>
        </div>
        <div style={{ marginTop: 10, display: 'grid', gridTemplateColumns: '1fr', gap: 8 }}>
          <label style={{ fontSize: 12, color: '#cbd5e1' }}>Frage springen</label>
          <select
            style={{ ...inputStyle, background: '#101520', color: '#f8fafc' }}
            value=""
            onChange={(e) => {
              const id = e.target.value;
              if (!id) return;
              if (window.confirm(`Frage ${id} jetzt starten?`)) {
                doAction(() => startQuestion(roomCode, id), `Frage ${id} gestartet`);
              }
              e.target.value = '';
            }}
          >
            <option value="">Frage wÃ¤hlen â€¦</option>
            {questionsList.map((q) => (
              <option key={q.id} value={q.id}>
                {q.id} Â· {q.question.slice(0, 60)}
              </option>
            ))}
          </select>
        </div>
      </section>

      <section style={{ display: 'grid', gridTemplateColumns: '1fr', gap: 10 }}>
        <div style={card}>
          <div style={{ fontWeight: 800, marginBottom: 6 }}>Antwort-Tendenzen</div>
          {numericStats ? (
            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', fontSize: 13 }}>
              <span>Min: {numericStats.min}</span>
              <span>Median: {numericStats.median}</span>
              <span>Ã˜: {numericStats.avg}</span>
              <span>Max: {numericStats.max}</span>
              <span>n={numericStats.count}</span>
            </div>
          ) : topTexts.length > 0 ? (
            <div style={{ display: 'flex', flexDirection: 'column', gap: 6 }}>
              {topTexts.map(([txt, count]) => (
                <div key={txt} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 13 }}>
                  <span>{txt}</span>
                  <span style={{ color: '#cbd5e1' }}>{count}x</span>
                </div>
              ))}
            </div>
          ) : (
            <div style={{ color: '#94a3b8', fontSize: 13 }}>Noch keine Antworten.</div>
          )}
        </div>

        <div style={card}>
          <div style={{ fontWeight: 800, marginBottom: 6 }}>Teams</div>
          {answers ? (
            <>
              <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap', fontSize: 13, marginBottom: 8 }}>
                <span>Teams im Raum: {Object.keys(answers.teams).length}</span>
                <span>Antworten: {Object.keys(answers.answers).length}</span>
              </div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 6, maxHeight: 180, overflow: 'auto' }}>
                {unansweredList.map((t) => (
                  <div
                    key={t.id}
                    style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                      alignItems: 'center',
                      fontSize: 13,
                      padding: '6px 8px',
                      borderRadius: 10,
                      background: t.answered ? 'rgba(52,211,153,0.12)' : 'rgba(248,180,0,0.08)'
                    }}
                  >
                    <span>{t.name}</span>
                    <span style={{ color: t.answered ? '#34d399' : '#fbbf24' }}>{t.answered ? 'geantwortet' : 'offen'}</span>
                  </div>
                ))}
              </div>
            </>
          ) : (
            <div style={{ color: '#94a3b8', fontSize: 13 }}>Noch keine Daten.</div>
          )}
        </div>
      </section>

      {toast && (
        <div
          style={{
            position: 'fixed',
            bottom: 16,
            left: '50%',
            transform: 'translateX(-50%)',
            background: '#0f172a',
            border: '1px solid rgba(255,255,255,0.1)',
            color: '#e2e8f0',
            padding: '10px 14px',
            borderRadius: 12,
            boxShadow: '0 10px 24px rgba(0,0,0,0.35)'
          }}
        >
          {toast}
        </div>
      )}
    </main>
  );
};

export default ModeratorPage;

